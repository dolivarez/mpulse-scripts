const HIGH_DOSE_RULES = {
  "¬µSv": 100,
  "mR": 100
};

const HIGH_DOSE_MESSAGE_FIELD = "CustomFields.OBJ_818";
const SUMMARY_DOSE_SELECTOR = "#OBJ_858 input.dx-texteditor-input";

const HIGH_DOSE_TAG = "RISK: High Dose Reported";


(function () {

  /* ================= CLEANUP ================= */
  document.querySelectorAll("#mpulseHoverDock").forEach(el => el.remove());
  document.querySelectorAll("#doseCorrectionModal").forEach(el => el.remove());
  document.querySelector("#OBJ_858 input")
    ?.style.setProperty("caret-color", "transparent");



  /* ================= CONFIG ================= */
  const MEMO_FIELDNAME = "CustomFields.OBJ_845";
  const DOSE_UNIT = "mR";

  /* ================= HELPERS ================= */
  function getUser() {
    const el = document.querySelector(
      "#navbar > ul > li:nth-child(3) > div > div > div.userDetails.dFlex > span.text-capitalize > span"
    );
    return el ? el.textContent.trim() : "Unknown User";
  }

  function nowISO() {
    return new Date().toISOString();
  }

  function findEditorByField(fieldName) {
  return Object.values(CKEDITOR.instances || {})
    .find(e => e.element?.getAttribute("fieldname") === fieldName);
}

  function lockDoseMemo() {
    const editor = findEditorByField("CustomFields.OBJ_845");
    if (!editor) return;
  
    // Disable keyboard input
    editor.on("key", evt => evt.cancel());
    editor.on("paste", evt => evt.cancel());
  
    // Hide toolbar if visible
    editor.config.removePlugins = "toolbar";
  
    // Optional visual cue
    editor.document.getBody().setStyle("background-color", "#f8fafc");
  
    console.log("üîí Dose memo locked (structured data only)");
  }


  function writeHighDoseMessage({ value, unit, enteredBy, timestamp }) {

  const editor = findEditorByField(HIGH_DOSE_MESSAGE_FIELD);
  if (!editor) {
    console.warn("‚ùå High-dose message field not found:", HIGH_DOSE_MESSAGE_FIELD);
    return;
  }

  const threshold = HIGH_DOSE_RULES[unit];
  if (threshold === undefined) return;

  const existing = editor.getData();

  // prevent duplicate message for same timestamp
  if (existing.includes(timestamp)) {
    console.log("‚Ñπ High-dose message already logged");
    return;
  }

  const block = `
    <hr>
    <p><strong>‚ö† HIGH DOSE FLAG</strong></p>
    <p><strong>Reported Dose:</strong> ${value} ${unit}</p>
    <p><strong>Threshold Exceeded:</strong> ‚â• ${threshold} ${unit}</p>
    <p><em>Detected by system rule</em></p>
    <p><em>Entered by: ${enteredBy}</em></p>
    <p><em>Timestamp: ${new Date(timestamp).toLocaleString()}</em></p>
  `;

  editor.setData(existing + block);

  console.warn("‚ö† High-dose message written to OBJ_818");
}


function evaluateDoseAndNotify(value, unit) {

  const threshold = HIGH_DOSE_RULES[unit];
  if (threshold === undefined) return;

  if (value >= threshold) {
    writeHighDoseMessage({
      value,
      unit,
      enteredBy: getUser(),
      timestamp: nowISO()
    });
  }
}

function waitForFormView(timeout = 4000) {
  const start = Date.now();
  
  return new Promise(resolve => {
    const check = () => {
      if (window.__MPULSE_FORMVIEW__?.ObjTaskList) {
        return resolve(window.__MPULSE_FORMVIEW__);
      }
  
      if (Date.now() - start > timeout) {
        console.warn("‚ö† FormView not available in time");
        return resolve(null);
      }
  
      requestAnimationFrame(check);
    };
  
    check();
  });
  }

function getPersonnelList() {
  const ctx = window.__MPULSE_FORMVIEW__;
  if (!ctx?.ObjTaskList) return [];

  const map = new Map(); // Code ‚Üí employee (CANONICAL)

  ctx.ObjTaskList.forEach(task => {
    task.AssetList?.forEach(asset => {
      asset.ListOfEmployee?.forEach(emp => {
        if (!emp?.Code) return;

        // ‚úÖ Dedupe by EMP-/VEN- code
        if (!map.has(emp.Code)) {
          map.set(emp.Code, {
            id: emp.RecordKey,        // keep one representative key
            name: emp.Description,
            code: emp.Code
          });
        }
      });
    });
  });

  return [...map.values()];
}


  
  function refreshDosePersonnel() {
    const select = document.getElementById("dosePersonSelect");
    if (!select) return;
  
    select.innerHTML = `<option value="">Dose applies to‚Ä¶</option>`;
  
    const personnel = getPersonnelList();
  
    if (!personnel.length) {
      const opt = document.createElement("option");
      opt.textContent = "No personnel on work order";
      opt.disabled = true;
      select.appendChild(opt);
      return;
    }
  
    personnel.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.code?.startsWith("VEN")
        ? `üèó ${p.name} (${p.code})`
        : `üë§ ${p.name} (${p.code})`;
      opt.dataset.name = p.name;
      opt.dataset.code = p.code;
      select.appendChild(opt);
    });
  }




  

function parseStructuredRecords() {
  const editor = findEditorByField("CustomFields.OBJ_845");
  if (!editor) return null;

  // ‚úÖ Get PLAIN TEXT (not HTML)
  const text =
  editor.document?.getBody()?.getText?.() ||
  editor.getData().replace(/<[^>]+>/g, "");


  return [...text.matchAll(
    /--- STRUCTURED DATA ---\s*({[\s\S]*?})\s*----------------------/g
  )]
    .map(m => {
        try {
          return JSON.parse(m[1]);
        } catch {
          return null;
        }
      })
      .filter(Boolean);
  }
    




function aggregateDoseByEmployee(records) {
  const entries = records.filter(r => r.type === "dose_entry");
  const corrections = records.filter(r => r.type === "dose_correction");

  const correctionsByEntry = new Map();
  corrections.forEach(c => {
    if (!correctionsByEntry.has(c.correctsEntryId)) {
      correctionsByEntry.set(c.correctsEntryId, []);
    }
    correctionsByEntry.get(c.correctsEntryId).push(c);
  });

  const empMap = new Map();

  entries.forEach(e => {
    const empId = e.doseFor?.empId;
    if (!empId) return;

    const corrList = correctionsByEntry.get(e.entryId) || [];
    const latestCorrection = corrList.at(-1);
    const effectiveDose = latestCorrection
      ? Number(latestCorrection.correctedDose)
      : Number(e.doseValue);

    if (!empMap.has(empId)) {
      empMap.set(empId, {
        empId,
        name: e.doseFor.name,
        unit: e.unit,
        total: 0,
        entries: []
      });
    }

    const row = empMap.get(empId);

    row.total += effectiveDose;
    row.entries.push({
      ...e,
      effectiveDose,
      corrections: corrList
    });
  });

  return [...empMap.values()];
}
  

async function writeSummaryDoseToField(records) {
  const editor = findEditorByField(MEMO_FIELDNAME);
  if (!editor || editor.readOnly) return;

  const data = aggregateDoseByEmployee(records);
  const total = data.reduce((s, e) => s + e.total, 0);
  const value = Number(total.toFixed(2));

  const ok = setTotalDoseAngular(value);

  if (!ok) {
    console.warn("‚ùå Failed to write Total Dose via Angular");
    return;
  }

  console.log("üíæ Total Dose written and WILL SAVE:", value);
}



function setDevExtremeValue(fieldId, value) {
  const root = document.querySelector(fieldId);
  if (!root) return false;

  const widgetEl =
    root.querySelector(".dx-numberbox") ||
    root.querySelector(".dx-textbox") ||
    root.querySelector(".dx-texteditor");

  if (!widgetEl) return false;

  let inst = null;


  if (!inst) return false;

  // 1Ô∏è‚É£ Update DevExtreme widget
  inst.option("value", value);

  // 2Ô∏è‚É£ üîë Update MPulse FormView model
  if (window.__MPULSE_FORMVIEW__?.CustomFields) {
    window.__MPULSE_FORMVIEW__.CustomFields["OBJ_858"] = value;
  }

  // 3Ô∏è‚É£ üîî Mark field dirty (critical)
  if (window.SetFormFieldValue) {
    SetFormFieldValue("CustomFields.OBJ_858", value);
  }

  // 4Ô∏è‚É£ Final nudge
  const input = widgetEl.querySelector("input");
  if (input) {
    input.dispatchEvent(new Event("input", { bubbles: true }));
    input.dispatchEvent(new Event("change", { bubbles: true }));
    input.blur();
  }

  console.log("üß† Total Dose set + bound:", value);
  return true;
}


function activateFinancialTab() {
  const tab = [...document.querySelectorAll(".nav-tabs li, .dx-tab")]
    .find(el => /financial/i.test(el.innerText));

  if (tab) {
    tab.click();
    return true;
  }

  console.warn("‚ùå Financial tab not found");
  return false;
}

  (function persistentTotalDoseLock() {
  const FIELD_ID = "#OBJ_858";

  function lock() {
    const root = document.querySelector(FIELD_ID);
    if (!root) return;

    const widget =
      root.querySelector(".dx-numberbox") ||
      root.querySelector(".dx-texteditor");

    const input = root.querySelector("input.dx-texteditor-input");

    /* ========= DEVEXTREME LEVEL ========= */
    try {
      const inst =
        window.$ &&
        (
          $(widget).dxNumberBox?.("instance") ||
          $(widget).dxTextBox?.("instance")
        );

      if (inst) {
        inst.option("readOnly", true);   // üîë REQUIRED
        inst.option("focusStateEnabled", false);
        inst.option("hoverStateEnabled", false);
      }
    } catch {}

    /* ========= DOM LEVEL ========= */
    root.style.pointerEvents = "none";
    root.style.opacity = "0.85";

    /* ========= INPUT LEVEL ========= */
    if (input) {
      input.setAttribute("readonly", "true");
      input.tabIndex = -1;

      input.onkeydown = e => e.preventDefault();
      input.onpaste = e => e.preventDefault();
      input.onfocus = () => input.blur();
    }
  }

  setInterval(lock, 500);
})();

  (function killTotalDosePencil() {
  const CONTROL_KEY = "3767"; // OBJ_858

  function hidePencil() {
    document
      .querySelectorAll(`span.editor[ng-click*="${CONTROL_KEY}"]`)
      .forEach(el => {
        el.style.display = "none";
        el.style.pointerEvents = "none";
        el.title = "Calculated field (system)";
      });
  }

  setInterval(hidePencil, 500);
})();


  (function hardBlockTotalDoseKeys() {
  document.addEventListener("keydown", e => {
    const input = document.querySelector("#OBJ_858 input.dx-texteditor-input");
    if (!input) return;

    if (document.activeElement !== input) return;

    const blockedKeys = [
      "Backspace",
      "Delete",
      "ArrowLeft",
      "ArrowRight",
      "Home",
      "End"
    ];

    if (blockedKeys.includes(e.key)) {
      e.preventDefault();
      e.stopImmediatePropagation();
      console.warn("üîí Hard-blocked key on Total Dose:", e.key);
      input.blur(); // kick focus to be extra safe
    }
  }, true); // üîë capture phase
})();


  (function guardDxNumberBoxClear() {
  const FIELD_ID = "#OBJ_858";

  function attach() {
    const root = document.querySelector(FIELD_ID);
    if (!root || !window.$) return;

    const widget =
      root.querySelector(".dx-numberbox") ||
      root.querySelector(".dx-texteditor");

    if (!widget) return;

    const inst =
      $(widget).dxNumberBox?.("instance") ||
      $(widget).dxTextBox?.("instance");

    if (!inst || inst.__doseGuardAttached) return;

    inst.__doseGuardAttached = true;

    let lastGood = inst.option("value");

    inst.on("valueChanged", e => {
      const isSystem =
        angular.element(root).scope()?.$root?.__SYSTEM_WRITING_DOSE__;

      const invalid =
        e.value === "" ||
        e.value === null ||
        typeof e.value === "undefined" ||
        Number.isNaN(e.value);
    
      // Capture valid system-written numbers
      if (!invalid && typeof e.value === "number") {
        lastGood = e.value;
        return;
      }
    
      // üö® Block ALL user clears (including delete/backspace)
      if (invalid && !isSystem) {
        console.warn("üîí Blocked manual clear of Total Dose");
    
        inst.option("value", lastGood);
        return;
      }
    });

    // Optional: remove clear button if present
    inst.option("showClearButton", false);
  }

  setInterval(attach, 300);
})();





 function setTotalDoseAngular(value) {
  const el = document.querySelector("#OBJ_858");
  if (!el) return false;

  const scope =
    angular.element(el).scope() ||
    angular.element(el).isolateScope();

  if (!scope) return false;

  scope.$applyAsync(() => {
    scope.$root.__SYSTEM_WRITING_DOSE__ = true;
    scope.$root.numberValues.OBJ_858.value = Number(value);
    scope.$root.__SYSTEM_WRITING_DOSE__ = false;
  });

  return true;
}







async function renderDoseTable(container) {
  const records = parseStructuredRecords();
  if (!records) {
    setTimeout(() => renderDoseTable(container), 300);
    return;
  }

  const data = aggregateDoseByEmployee(records);

// üîó WRITE SUMMARY DOSE
await writeSummaryDoseToField(records);



  container.innerHTML = `
    <div style="margin-top:10px;font-weight:bold">üìä Accrued Dose</div>
    <table style="width:100%;font-size:12px;border-collapse:collapse;margin-top:6px">
      <thead>
        <tr style="background:#e5e7eb">
          <th style="text-align:left;padding:4px">Employee</th>
          <th style="text-align:right;padding:4px">Total</th>
          <th style="text-align:right;padding:4px">Entries</th>
        </tr>
      </thead>
      <tbody>
        ${
          data.length
            ? data.map(emp => `
              <tr class="emp-row" style="cursor:pointer;background:#f8fafc"
                  onclick="toggleDoseRows('${emp.empId}')">
                <td style="padding:4px">
                  ‚ñ∂ ${emp.name}
                  <span style="color:#64748b">(${emp.empId})</span>
                </td>
                <td style="padding:4px;text-align:right">
                  ${emp.total.toFixed(2)} ${emp.unit}
                  ${
                    emp.entries.some(e => e.corrections.length)
                      ? `<span style="color:#b45309;font-size:11px"> (corrected)</span>`
                      : ""
                  }
                </td>
                <td style="padding:4px;text-align:right">
                  ${emp.entries.length}
                </td>
              </tr>

              <tr id="rows-${emp.empId}" style="display:none">
                <td colspan="3" style="padding:6px">
                  ${renderEntrySubTable(emp)}
                </td>
              </tr>
            `).join("")
            : `<tr>
                 <td colspan="3" style="padding:6px;color:#64748b">
                   No dose recorded
                 </td>
               </tr>`
        }
      </tbody>
    </table>
  `;
}


function renderEntrySubTable(emp) {
  return `
    <table style="width:100%;font-size:11px;border-collapse:collapse">
      <thead style="position:sticky;top:0;background:#eef2f7;z-index:1">
        <tr style="background:#eef2f7">
          <th style="text-align:left;padding:4px">Timestamp</th>
          <th style="text-align:right;padding:4px">Original</th>
          <th style="text-align:right;padding:4px">Effective</th>
          <th style="text-align:left;padding:4px">Status</th>
          <th style="text-align:right;padding:4px">Action</th>
        </tr>
      </thead>
      <tbody>
        ${
          emp.entries.map(e => `
            <tr>
              <td style="padding:4px">
                ${new Date(e.timestamp).toLocaleString()}
              </td>
              <td style="padding:4px;text-align:right">
                ${Number(e.doseValue).toFixed(2)} ${e.unit}
              </td>
              <td style="padding:4px;text-align:right">
                ${Number(e.effectiveDose).toFixed(2)} ${e.unit}
              </td>
              <td style="padding:4px">
                ${
                  e.corrections.length
                    ? `‚úè Corrected (${e.corrections.length})`
                    : `‚úì Original`
                }
              </td>
              <td style="padding:4px;text-align:right">
                <button
                  style="font-size:11px"
                  onclick='window.openDoseCorrection(${JSON.stringify(e)})'>
                  ‚úè
                </button>
              </td>
            </tr>
          `).join("")
        }
      </tbody>
    </table>
  `;
}



  function makeDraggable(dock, handle) {
    let startX = 0, startY = 0, x = 0, y = 0;
  
    handle.onmousedown = e => {
      e.preventDefault();
    
      // üîë remove centering transform once user drags
      dock.style.transform = "none";
    
      startX = e.clientX;
      startY = e.clientY;
      document.onmousemove = drag;
      document.onmouseup = stop;
    };

  
    function drag(e) {
      e.preventDefault();
      x = startX - e.clientX;
      y = startY - e.clientY;
      startX = e.clientX;
      startY = e.clientY;
  
      dock.style.top = (dock.offsetTop - y) + "px";
      dock.style.left = (dock.offsetLeft - x) + "px";
      dock.style.right = "auto";
      dock.style.bottom = "auto";
    }
  
    function stop() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }



function attachDoseHeaderButtonWhenEditable() {
  const ta = document.querySelector(
    `textarea[fieldname="${MEMO_FIELDNAME}"]`
  );
  if (!ta) return;

  const label = ta.closest("div")?.querySelector("label");
  if (!label) return;

  const editor = findEditorByField(MEMO_FIELDNAME);
  if (!editor) return;

  // Only show button when editor is editable
  if (editor.readOnly) {
    label.querySelector(".dose-btn")?.remove();
    return;
  }

  if (label.dataset.doseAttached) return;

  const btn = document.createElement("button");
  btn.className = "dose-btn";
  btn.textContent = "‚ûï Add Dose";

  Object.assign(btn.style, {
    marginLeft: "8px",
    padding: "2px 10px",
    fontSize: "12px",
    borderRadius: "12px",
    border: "1px solid #2563eb",
    background: "#fff",
    color: "#2563eb",
    cursor: "pointer"
  });

  btn.onclick = () => {
    refreshDosePersonnel();
    const dock = document.getElementById("mpulseHoverDock");
    if (dock) dock.style.display = "block";
  };


  label.appendChild(btn);
  label.dataset.doseAttached = "true";

  console.log("‚ûï Dose button attached (editable state)");
}

(function interceptGetFormViewData() {
  if (typeof window.GetFormViewData !== "function") {
    return setTimeout(interceptGetFormViewData, 300);
  }

  const original = window.GetFormViewData;

  window.GetFormViewData = function (...args) {
    const result = original.apply(this, args);

    // MPulse replaces __MPULSE_FORMVIEW__ asynchronously
    setTimeout(() => {
      console.log("üì° FormView reloaded ‚Üí refreshing dose personnel");
      refreshDosePersonnel();
    }, 500);

    return result;
  };

  console.log("‚úÖ GetFormViewData intercepted");
})();

  (function interceptSaveTabAndKey() {
  if (typeof window.SaveTabAndKey !== "function") {
    return setTimeout(interceptSaveTabAndKey, 300);
  }

  const original = window.SaveTabAndKey;

  window.SaveTabAndKey = async function (...args) {
    try {
      const editor = findEditorByField(MEMO_FIELDNAME);
      if (editor && !editor.readOnly) {
        activateFinancialTab();                 // üëà KEY
        const records = parseStructuredRecords();
        if (records) await writeSummaryDoseToField(records);
      }
    } catch (e) {
      console.warn("‚ùå Failed to write summary dose before save", e);
    }

    return original.apply(this, args);
  };

  console.log("‚úÖ SaveTabAndKey intercepted + Financial tab activation");
})();


function activateFinancialTab() {
  const tab = [...document.querySelectorAll("a, .dx-tab")]
    .find(el => /financial/i.test(el.innerText));

  if (tab) {
    tab.click();
    return true;
  }
  return false;
}


function getTotalDoseInstance() {
  const root = document.querySelector("#OBJ_858");
  if (!root || !window.$) return null;

  // Accept ALL possible editor types
  const widget =
    root.querySelector(".dx-numberbox") ||
    root.querySelector(".dx-textbox") ||
    root.querySelector(".dx-texteditor");

  if (!widget) return null;

  // Try jQuery adapters (MPulse style)
  return (
    $(widget).dxTextEditor?.("instance") ||
    null
  );
}

  

  function writeTotalDose(value) {
  const root = document.querySelector("#OBJ_858");
  const widget = root?.querySelector(".dx-numberbox");

  const inst =
    window.$ && $(widget).dxNumberBox?.("instance");

  if (!inst) return;

  inst.option("readOnly", false);
  inst.option("value", value);
  inst.option("readOnly", true);
}





  let activeCorrectionTarget = null;

  function openCorrectionModal(entry) {
    activeCorrectionTarget = entry;
  
    document.getElementById("corrInfo").innerHTML = `
      <strong>${entry.doseFor.name}</strong><br>
      Original: ${entry.doseValue} ${entry.unit}<br>
      Entered: ${new Date(entry.timestamp).toLocaleString()}
    `;
  
    document.getElementById("corrValue").value = entry.doseValue;
    document.getElementById("corrReason").value = "";
  
    correctionModal.style.display = "flex";
  }

  window.openDoseCorrection = openCorrectionModal;
  window.toggleDoseRows = function (empId) {
  const row = document.getElementById(`rows-${empId}`);
  if (!row) return;

  row.style.display = row.style.display === "none" ? "table-row" : "none";
};








  /* ================= UI ================= */
  const dock = document.createElement("div");
  dock.id = "mpulseHoverDock";
  dock.style.cssText = `
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    z-index:9999;
    font-family:Arial, sans-serif;
  `;


  const correctionModal = document.createElement("div");
correctionModal.id = "doseCorrectionModal";
correctionModal.style.cssText = `
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  z-index:100000;
  align-items:center;
  justify-content:center;
`;

correctionModal.innerHTML = `
  <div style="
    background:#fff;
    width:380px;
    padding:14px;
    border-radius:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.3);
    font-family:system-ui;
  ">
    <div style="font-weight:600;margin-bottom:8px">
      ‚úèÔ∏è Correct Dose Entry
    </div>

    <div id="corrInfo" style="font-size:12px;color:#475569;margin-bottom:8px"></div>

    <input id="corrValue" type="number" step="any"
      placeholder="Corrected dose value"
      style="width:100%;padding:6px;margin-bottom:6px" />

    <input id="corrReason" type="text"
      placeholder="Reason for correction (required)"
      style="width:100%;padding:6px;margin-bottom:10px" />

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="corrCancel">Cancel</button>
      <button id="corrSave"
        style="background:#2563eb;color:white;border:none;padding:6px 10px;border-radius:4px">
        Save Correction
      </button>
    </div>
  </div>
`;

document.body.appendChild(correctionModal);

document.getElementById("corrCancel").onclick = () => {
  correctionModal.style.display = "none";
  activeCorrectionTarget = null;
  };

document.getElementById("corrSave").onclick = () => {
  const val = parseFloat(document.getElementById("corrValue").value);
  const reason = document.getElementById("corrReason").value.trim();
  
  if (!activeCorrectionTarget || isNaN(val) || !reason) {
    alert("Corrected value and reason are required.");
    return;
}

const editor = findEditorByField(MEMO_FIELDNAME);
if (!editor) return;

const correction = {
  type: "dose_correction",
  correctsEntryId: activeCorrectionTarget.entryId,
  originalDose: activeCorrectionTarget.doseValue,
  correctedDose: val,
  unit: activeCorrectionTarget.unit,
  reason,
  enteredBy: getUser(),
  timestamp: nowISO()
};

editor.setData(editor.getData() + `
--- STRUCTURED DATA ---
${JSON.stringify(correction)}
----------------------
`);

correctionModal.style.display = "none";
activeCorrectionTarget = null;

renderDoseTable(tableDiv);
setTimeout(() => {
  const recs = parseStructuredRecords();
  if (recs) writeSummaryDoseToField(recs);
}, 50);

};



  const panel = document.createElement("div");
  panel.style.cssText = `
    background:#f8fafc;
    border:1px solid #cbd5e1;
    border-radius:8px;
    padding:12px;
    width:560px;
    max-height:85vh;
    display:flex;
    flex-direction:column;
    box-shadow:0 8px 20px rgba(0,0,0,.3);
  `;


  panel.innerHTML = `
      <div id="doseHeaderBar" style="
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:bold;
      margin-bottom:6px;
      cursor:move;
    ">
      <span>‚ò¢ Dose Entry (JSON)</span>
      <button id="doseCloseBtn" style="
        background:none;
        border:none;
        font-size:16px;
        cursor:pointer;
        color:#64748b;
      ">‚úï</button>
    </div>

    <input id="doseValueInput" type="number" step="0.01" placeholder="Dose value"
      style="width:100%;padding:6px;margin-bottom:6px" />
      <div style="font-size:11px;color:#64748b;margin-bottom:6px">
        Units: mR
      </div>


    <select id="dosePersonSelect"
      style="width:100%;padding:6px;margin-bottom:6px">
      <option value="">Dose applies to‚Ä¶</option>
    </select>

    <button id="recordDoseBtn"
      style="width:100%;padding:6px;background:#2563eb;color:white;border:none;border-radius:4px">
      Record Dose (JSON)
    </button>

    <div id="doseStatusMsg"
      style="margin-top:6px;font-size:12px"></div>
  `;

  const tableDiv = document.createElement("div");
  tableDiv.style.cssText = `
    margin-top:10px;
    flex:1;
    overflow-y:auto;
    border-top:1px solid #e5e7eb;
    padding-top:8px;
  `;
  
  panel.appendChild(tableDiv);

  
  // initial render
  setTimeout(() => renderDoseTable(tableDiv), 600);
  
  dock.appendChild(panel);
  document.body.appendChild(dock);   // üëà attach FIRST
  dock.style.display = "none";   // üî¥ REQUIRED
  // ================= ESC CLOSE (ONE-TIME) =================
  if (!dock.dataset.escBound) {
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && dock.style.display !== "none") {
        dock.style.display = "none";
      }
    });
    dock.dataset.escBound = "true";
  }

  setTimeout(() => {
    refreshDosePersonnel();
  }, 800);
  (function lockWhenEditable() {
    const editor = findEditorByField(MEMO_FIELDNAME);
    if (!editor) return setTimeout(lockWhenEditable, 300);
  
    if (!editor.readOnly) {
      lockDoseMemo();
    }
  })();

  makeDraggable(dock, panel.querySelector("#doseHeaderBar"));

    (function watchDoseEditState() {
    let lastState = null;
  
    setInterval(() => {
      const editor = findEditorByField(MEMO_FIELDNAME);
      if (!editor) return;
  
      const editable = !editor.readOnly;
  
      if (editable !== lastState) {
        attachDoseHeaderButtonWhenEditable();
        lastState = editable;
      }
    }, 400);
  })();


  
  const personSelect = panel.querySelector("#dosePersonSelect");

  if (!personSelect) {
    console.warn("‚ùå dosePersonSelect not found inside panel");
  } else {
    (async () => {
  const ctx = await waitForFormView();

  if (!ctx) {
    const opt = document.createElement("option");
    opt.textContent = "Personnel not loaded";
    opt.disabled = true;
    personSelect.appendChild(opt);
    return;
  }

  const personnel = getPersonnelList();

  if (!personnel.length) {
    const opt = document.createElement("option");
    opt.textContent = "No personnel on task";
    opt.disabled = true;
    personSelect.appendChild(opt);
  } else {
    personnel.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} (${p.code})`;
      opt.dataset.name = p.name;
      opt.dataset.code = p.code;
      personSelect.appendChild(opt);
    });
  }
})();
}



  /* ================= ACTION ================= */
  const recordBtn = panel.querySelector("#recordDoseBtn");
  const msg = panel.querySelector("#doseStatusMsg");

  const closeBtn = panel.querySelector("#doseCloseBtn");
  closeBtn.onmousedown = e => {
    e.stopPropagation();   // ‚õî block drag
  };

  
  if (!closeBtn.dataset.bound) {
    closeBtn.onclick = () => {
      dock.style.display = "none";
    };
    closeBtn.dataset.bound = "true";
  }

  
  recordBtn.onclick = () => {
  const value = parseFloat(panel.querySelector("#doseValueInput").value);
  const select = panel.querySelector("#dosePersonSelect");
  const opt = select.options[select.selectedIndex];

  if (!opt || isNaN(value)) {
    msg.textContent = "‚ö† Enter value and select a person.";
    return;
  }

  const editor = findEditorByField(MEMO_FIELDNAME);
  if (!editor) {
    msg.textContent = "‚ùå Memo field not found.";
    return;
  }

  const payload = {
    type: "dose_entry",
    entryId: `dose-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
    doseValue: value,
    unit: DOSE_UNIT, // ‚úÖ locked unit
    doseFor: {
      empId: opt.dataset.code,
      name: opt.dataset.name
    },
    enteredBy: getUser(),
    timestamp: nowISO()
  };

  editor.setData(editor.getData() + `
--- STRUCTURED DATA ---
${JSON.stringify(payload)}
----------------------
`);

  evaluateDoseAndNotify(value, DOSE_UNIT);
  renderDoseTable(tableDiv);

  // reset inputs
  panel.querySelector("#doseValueInput").value = "";
  panel.querySelector("#dosePersonSelect").value = "";

  msg.textContent = "‚úÖ JSON dose entry written.";
};

})();
