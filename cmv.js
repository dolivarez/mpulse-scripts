(()=>{if(window.__CMV_V2_ACTIVE__)return;window.__CMV_V2_ACTIVE__=!0;const e="cmv-panel-v2",t="cmv-toggle-v2",n="cmv-lightbox-v2",o="cmv-lightbox-main-v2";let i=null,a=[];const l={index:0,zoom:1,rotation:0,fit:"contain",theme:"dark",panX:0,panY:0};function d(){if(document.getElementById("cmv-v2-styles"))return;const e=document.createElement("style");e.id="cmv-v2-styles",e.textContent="#"+o+" img,#"+o+" video{max-width:100%!important;max-height:100%!important;object-fit:contain!important;transform-origin:center!important;}#"+o+" iframe{width:100%!important;height:100%!important;border:none!important;object-fit:contain!important;}#"+n+"{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);display:none;z-index:999999;align-items:center;justify-content:center;}#"+o+"{width:80vw;height:80vh;background:#111;border-radius:8px;display:flex;flex-direction:column;overflow:hidden;}."+o+"-light{background:#f7f7f7!important;} .cmv-lb-header{padding:6px 10px;background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;} .cmv-lb-main{flex:1;background:#000;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;} .cmv-lb-thumbs{height:80px;background:#181818;display:flex;overflow-x:auto;gap:4px;padding:4px;} .cmv-thumb{width:70px;height:60px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;border:2px solid transparent;cursor:pointer;flex:0 0 auto;} .cmv-thumb img{width:100%;height:100%;object-fit:contain;} .cmv-thumb.cmv-active{border-color:#00aaff;} .cmv-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);padding:10px 14px;font-size:28px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer;border-radius:20px;} .cmv-nav-left{left:10px;} .cmv-nav-right{right:10px;} #"+e+"{border:1px solid #ccc;padding:10px;background:#fafafa;border-radius:6px;margin-bottom:10px;}#"+t+"{margin-bottom:8px;padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;} .cmv-group{border:1px solid #ddd;border-radius:5px;margin-bottom:8px;} .cmv-group-header{padding:6px 10px;background:#eee;cursor:pointer;display:flex;justify-content:space-between;font-weight:600;} .cmv-group-body{display:none;padding:6px 10px;background:#fff;} .cmv-item{padding:5px 0;border-bottom:1px solid #eee;display:flex;align-items:center;gap:6px;} .cmv-label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;} #cmv-progress-v2{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;color:#fff;font-size:18px;z-index:1000000;}",document.head.appendChild(e)}function r(){if(i)return i;const e=performance.getEntries();for(const t of e){const e=t.name.match(/[?&]Token=([^&]+)/i);if(e)return i=e[1]}if(window.angular){const e=document.querySelectorAll("[ng-controller],[ng-repeat]");for(const t of e)try{const e=angular.element(t).scope();if(e?.Token)return i=e.Token;if(e?.$parent?.Token)return i=e.$parent.Token}catch{}}return null}function c(){try{const e=document.querySelector(".mobile-media-content-area");if(!e)return[];const t=e.querySelector("[ng-repeat='mediadetails in media']");return t?angular.element(t).scope()?.media||[]:[]}catch{return[]}}function s(e,t,n){const o=encodeURIComponent(e),i=encodeURIComponent(n),a=encodeURIComponent(t);return`${location.origin}/Media/DownloadMediaStream/${o}?Token=${i}&FileName=${o}&MediaKey=${a}`}function m(e,t,n){const o=`${t},${e},WorkOrderRecords`;return`${location.origin}/mediaviewer?fileName=${encodeURIComponent(o)}&Token=${encodeURIComponent(n)}`}function u(e){const t=r();if(!t)return{items:[],groups:null};const n={image:["jpg","jpeg","png","gif","bmp","tif","tiff"],video:["mp4","mov","webm","avi","wmv","mpeg","mpg"],doc:["pdf","doc","docx","xls","xlsx","csv","ppt","pptx","rtf","txt"]},o={Images:[],Videos:[],Documents:[],Other:[]},l=[];return e.forEach((e=>{const i=e.FileName,a=(i.split(".").pop()||"").toLowerCase(),d=e.Key;let r="other";n.image.includes(a)?r="image":n.video.includes(a)?r="video":n.doc.includes(a)&&(r="doc");const c={desc:e.Description||i,fileName:i,ext:a,kind:r,downloadUrl:s(i,d,t),viewerUrl:"doc"===r?m(i,d,t):s(i,d,t),flatIndex:l.length};l.push(c),"image"===r?o.Images.push(c):"video"===r?o.Videos.push(c):"doc"===r?o.Documents.push(c):o.Other.push(c)})),{items:l,groups:o}}function p(t,n){if(!document.getElementById(e))return;const o=document.getElementById(e);if("custom"===t){const e=h();o.innerHTML="",o.appendChild(e),o.style.display=""}else o.style.display="none"}function h(){d();const t=c(),n=document.createElement("div");if(n.id=e,!t.length)return n.innerHTML='<div class="cmv-title">Media Viewer (Custom)</div><i>No media found.</i>',n;const{items:o,groups:i}=u(t);return a=o,n.innerHTML=`<div class="cmv-title">Media Viewer (Custom)</div>${g("Images",i.Images)}${g("Videos",i.Videos)}${g("Documents",i.Documents)}${g("Other",i.Other)}`,n.querySelectorAll(".cmv-group-header").forEach((e=>e.addEventListener("click",(()=>{const t=e.nextElementSibling;t.style.display="block"===t.style.display?"none":"block"})))),n.querySelectorAll(".cmv-sel-all").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!0))})))),n.querySelectorAll(".cmv-sel-none").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!1))})))),n.querySelectorAll(".cmv-label, .cmv-item button").forEach((e=>e.addEventListener("click",(t=>{const n=Number(e.dataset.idx);isNaN(n)||f(n)})))),n}function g(e,t){return`<div class="cmv-group"><div class="cmv-group-header">${e} (${t.length}) <span>▼</span></div><div class="cmv-group-body"><button class="cmv-sel-all">Select All</button><button class="cmv-sel-none">None</button>${t.map((e=>`<div class="cmv-item"><input type="checkbox" class="cmv-select" data-idx="${e.flatIndex}"><span class="cmv-label" data-idx="${e.flatIndex}">${e.desc}</span><button data-idx="${e.flatIndex}">Preview</button></div>`)).join("")}</div></div>`}function v(){const e=document.querySelector(".mobile-media-content-area");if(!e)return;let n=document.getElementById(t);n||(n=document.createElement("button"),n.id=t,n.textContent="Switch to Custom Viewer",e.parentNode.insertBefore(n,e)),n.onclick=()=>{const t=document.getElementById(e);if(t&&"none"!==t.style.display)return t.style.display="none",e.style.display="",n.textContent="Switch to Custom Viewer",void 0;const o=h();o.style.display="",e.style.display="none",n.textContent="Switch to Native Viewer";const i=document.getElementById(e);i||e.parentNode.insertBefore(o,e)}}function y(){if(!document.getElementById(n)){const e=document.createElement("div");e.id=n,e.innerHTML=`<div id="${o}"><div class="cmv-lb-header"><span class="cmv-name"></span><div><button data-act="prev">◀</button><button data-act="next">▶</button><button data-act="zoom-in">+</button><button data-act="zoom-out">-</button><button data-act="zoom-reset">100%</button><button data-act="rotate-left">⟲</button><button data-act="rotate-right">⟳</button><button data-act="fit-width">Fit W</button><button data-act="fit-height">Fit H</button><button data-act="fit-original">1:1</button><button data-act="theme">☯</button><button data-act="download">⬇</button><button data-act="download-all">⇩ All</button><button data-act="download-selected">⇩ Selected</button><button data-act="close">✕</button></div></div><div class="cmv-lb-main"><div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div></div><div class="cmv-lb-thumbs"></div></div>`,document.body.appendChild(e),e.addEventListener("click",(e=>{const t=e.target.dataset.act;t&&(e.stopPropagation(),b(t))})),e.addEventListener("click",(e=>{e.target.id===n&&E()})),document.addEventListener("keydown",(e=>{const t=document.getElementById(n);if("flex"!==t.style.display)return;"Escape"===e.key&&E(),"ArrowRight"===e.key&&k(),"ArrowLeft"===e.key&&C()}));const t=e.querySelector(".cmv-lb-main");let o,i,a=!1;t.addEventListener("mousedown",(e=>{if(1!==e.button)return;const t=w();["image","video"].includes(t.kind)&&(e.preventDefault(),a=!0,o=e.clientX,i=e.clientY)})),document.addEventListener("mousemove",(e=>{if(!a)return;const t=w();l.panX+=e.clientX-o,l.panY+=e.clientY-i,o=e.clientX,i=e.clientY,x()}
)),document.addEventListener("mouseup",(()=>a=!1))}}function f(e){y(),l.index=e,l.zoom=1,l.rotation=0,l.panX=0,l.panY=0;const t=document.getElementById(n);t&&(t.style.display="flex",T())}function E(){const e=document.getElementById(n);e&&(e.style.display="none")}function b(e){switch(e){case"close":E();break;case"prev":C();break;case"next":k();break;case"zoom-in":l.zoom*=1.2,x();break;case"zoom-out":l.zoom/=1.2,x();break;case"zoom-reset":l.zoom=1,l.panX=0,l.panY=0,x();break;case"rotate-left":l.rotation=(l.rotation-90)%360,x();break;case"rotate-right":l.rotation=(l.rotation+90)%360,x();break;case"fit-width":l.fit="cover",x();break;case"fit-height":l.fit="contain",x();break;case"fit-original":l.fit="none",x();break;case"theme":l.theme="dark"===l.theme?"light":"dark",document.getElementById(o).classList.toggle("cmv-light","light"===l.theme);break;case"download":L();break;case"download-all":N();break;case"download-selected":O();break}}function w(){return a[l.index]}function k(){l.index=(l.index+1)%a.length,l.zoom=1,l.rotation=0,l.panX=0,l.panY=0,T(!0)}function C(){l.index=(l.index-1+a.length)%a.length,l.zoom=1,l.rotation=0,l.panX=0,l.panY=0,T(!0)}function T(e){const t=w(),n=document.getElementById(o),i=n.querySelector(".cmv-lb-main"),d=n.querySelector(".cmv-name"),r=n.querySelector(".cmv-lb-thumbs");d.textContent=t.desc,i.innerHTML=`<div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div>`;let c;"image"===t.kind?(c=document.createElement("img"),c.src=t.downloadUrl):"video"===t.kind?(c=document.createElement("video"),c.src=t.downloadUrl,c.controls=!0):(c=document.createElement("iframe"),c.src=t.viewerUrl),c.style.opacity=e?"1":"0",i.appendChild(c),requestAnimationFrame((()=>c.style.opacity="1")),x(),r.innerHTML="",a.forEach(((e,t)=>{const n=document.createElement("div");if(n.className="cmv-thumb"+(t===l.index?" cmv-active":""),n.title=e.desc,"image"===e.kind){const t=document.createElement("img");t.src=e.downloadUrl,n.appendChild(t)}else n.textContent=e.ext.toUpperCase();n.onclick=()=>{l.index=t,l.zoom=1,l.rotation=0,l.panX=0,l.panY=0,T(!0)},r.appendChild(n)}))}function x(){const e=document.getElementById(o),t=e.querySelector("img,video,iframe"),n=w();t&&("image"===n.kind||"video"===n.kind?(t.style.objectFit=l.fit,t.style.transform=`translate(${l.panX}px,${l.panY}px) scale(${l.zoom}) rotate(${l.rotation}deg)`):t.style.transform="none")}function L(){const e=w();let t=(e.desc||e.fileName).replace(/[\\\/:*?"<>|]/g,"_");t.toLowerCase().endsWith("."+e.ext)||(t+="."+e.ext);const n=document.createElement("a");n.href=e.downloadUrl,n.download=t,n.click()}function S(){const e=document.querySelector("#ID");return(e?.innerText||e?.value||"WorkOrder").trim()}function U(){return[...document.querySelectorAll(".cmv-select:checked")].map((e=>a[e.dataset.idx]))}function A(e){const t=document.getElementById("cmv-progress-v2");t&&(t.style.display="none")}function N(){const e=a;(async function(e){let t=document.getElementById("cmv-progress-v2");t||(t=document.createElement("div"),t.id="cmv-progress-v2",t.innerHTML='<div id="cmv-progress-text-v2"></div>',document.body.appendChild(t));t.style.display="flex",document.getElementById("cmv-progress-text-v2").innerText="Preparing ZIP…";const n=await new Promise((t=>{if(window.JSZip)t(window.JSZip);else{const e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",e.onload=()=>t(window.JSZip),document.head.appendChild(e)}}));const o=new n,i=e.length;let d=0;for(const n of e){d++,document.getElementById("cmv-progress-text-v2").innerText=`Downloading ${d}/${i}…`;try{const e=await(await fetch(n.downloadUrl)).arrayBuffer();let t=n.desc.replace(/[\\\/:*?"<>|]/g,"_");t.toLowerCase().endsWith("."+n.ext)||(t+="."+n.ext);let i="Other";"image"===n.kind?i="Images":"video"===n.kind?i="Videos":"doc"===n.kind&&(i="Documents"),o.folder(i).file(t,e)}catch(e){console.error("Download failed:",n,e)}}document.getElementById("cmv-progress-text-v2").innerText="Finalizing ZIP…";const l=await o.generateAsync({type:"blob"});A();const d=document.createElement("a");d.href=URL.createObjectURL(l),d.download=S()+".zip",d.click()})(e)}function O(){const e=U();N(e)}new MutationObserver((()=>v())).observe(document.body,{childList:!0,subtree:!0}),v()})();
