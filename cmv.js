(()=>{if(window.__CMV_V2_ACTIVE__)return;window.__CMV_V2_ACTIVE__=!0;const e="cmv-panel-v2",t="cmv-toggle-v2",n="cmv-lightbox-v2",i="cmv-lightbox-main-v2";let o=null,a=[];const r={index:0,zoom:1,rotation:0,fit:"contain",theme:"dark",panX:0,panY:0};function l(){if(document.getElementById("cmv-v2-styles"))return;const t=`#${e}{border:1px solid #ccc;border-radius:6px;background:#fafafa;padding:10px;margin-bottom:10px;font-size:13px;max-height:70vh;overflow-y:auto}#${e} .cmv-title{font-weight:600;margin-bottom:6px}.cmv-group{border:1px solid #ddd;border-radius:5px;margin-bottom:6px}.cmv-group-header{padding:6px 8px;cursor:pointer;background:#eee;font-weight:600;display:flex;justify-content:space-between;align-items:center}.cmv-group-body{display:none;padding:8px;background:#fff}.cmv-group-tools{display:flex;gap:4px;margin-bottom:4px}.cmv-item{padding:4px 0;display:flex;align-items:center;gap:6px;border-bottom:1px solid #eee}.cmv-item:last-child{border-bottom:none}.cmv-label{flex:1;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#${t}{margin-bottom:8px;padding:5px 10px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px}#${n}{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:999999}#${i}{width:80vw;height:80vh;background:#111;border-radius:8px;box-shadow:0 0 12px rgba(0,0,0,.4);display:flex;flex-direction:column;overflow:hidden}#${i}.cmv-light{background:#f0f0f0}.cmv-lb-header{padding:6px 10px;display:flex;justify-content:space-between;align-items:center;background:#222;color:#fff}.cmv-light .cmv-lb-header{background:#ddd;color:#000}.cmv-lb-main{flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}.cmv-lb-main img,.cmv-lb-main video{max-width:100%!important;max-height:100%!important;width:auto!important;height:auto!important;object-fit:contain!important;transform-origin:center center}.cmv-lb-main iframe{width:100%!important;height:100%!important;border:none!important}.cmv-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);font-size:32px;padding:8px 12px;border-radius:24px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer}.cmv-lb-thumbs{height:80px;background:#181818;display:flex;overflow-x:auto;gap:4px;padding:6px}.cmv-thumb{width:70px;height:60px;border-radius:4px;overflow:hidden;background:#333;border:2px solid transparent;display:flex;align-items:center;justify-content:center;flex:0 0 auto}.cmv-thumb img{width:100%;height:100%;object-fit:contain}.cmv-thumb.cmv-active{border-color:#00aeff}#cmv-progress-v2{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);color:#fff;display:none;align-items:center;justify-content:center;z-index:1000000;font-size:18px}`,n=document.createElement("style");n.id="cmv-v2-styles",n.textContent=t,document.head.appendChild(n)}function d(){if(o)return o;for(const e of performance.getEntries()){const t=e.name.match(/[?&]Token=([^&]+)/);if(t)return o=t[1]}if(window.angular){const e=document.querySelectorAll("[ng-controller], [ng-repeat]");for(let t of e)try{const e=angular.element(t).scope();if(e?.Token)return o=e.Token;if(e?.$parent?.Token)return o=e.$parent.Token}catch{}}return null}function c(e){let t=0;function n(){t++;const o=document.querySelector('[ng-repeat="mediadetails in media"]');if(o&&window.angular)try{const t=angular.element(o).scope();if(t&&Array.isArray(t.media)&&t.media.length>0)return e(t.media)}catch{}t<50?setTimeout(n,150):console.warn("CMV: media scope did not load.")}n()}function m(e,t,n){const i=encodeURIComponent(e),o=encodeURIComponent(n),a=encodeURIComponent(t);return`${location.origin}/Media/DownloadMediaStream/${i}?Token=${o}&FileName=${i}&MediaKey=${a}`}function u(e,t,n){const i=`${t},${e},WorkOrderRecords`;return`${location.origin}/mediaviewer?fileName=${encodeURIComponent(i)}&Token=${encodeURIComponent(n)}`}function p(e){const t=d(),n={Images:[],Videos:[],Documents:[],Other:[]},i=[];return e.forEach((e=>{const o=e.FileName,a=(o.split(".").pop()||"").toLowerCase(),r=(e.FileType||"").toLowerCase(),l=e.Key;let d="other";["jpg","jpeg","png","gif","bmp","tif"].includes(r)?d="image":["mp4","mov","webm","avi"].includes(r)?d="video":["pdf","doc","xls","ppt","txt","csv"].includes(r)&&(d="doc");const c={desc:e.Description||o,fileName:o,ext:a,kind:d,viewerUrl:"doc"===d?u(o,l,t):m(o,l,t),downloadUrl:m(o,l,t),flatIndex:i.length};i.push(c),"image"===d?n.Images.push(c):"video"===d?n.Videos.push(c):"doc"===d?n.Documents.push(c):n.Other.push(c)})),{items:i,groups:n}}function s(t,n){return`<div class="cmv-group"><div class="cmv-group-header"><span>${t} (${n.length})</span><span>▼</span></div><div class="cmv-group-body"><div class="cmv-group-tools"><button class="cmv-sel-all">Select All</button><button class="cmv-sel-none">None</button></div>${n.map((e=>`<div class="cmv-item"><input type="checkbox" class="cmv-select" data-idx="${e.flatIndex}"><span class="cmv-label" data-idx="${e.flatIndex}">${e.desc}</span><button data-idx="${e.flatIndex}">Preview</button></div>`)).join("")}</div></div>`}function v(e){const t=document.getElementById("cmv-body-v2");t.innerHTML=s("Images",e.Images)+s("Videos",e.Videos)+s("Documents",e.Documents)+s("Other",e.Other);const n=t.querySelector(".cmv-group-body");n&&(n.style.display="block"),t.querySelectorAll(".cmv-group-header").forEach((e=>{e.addEventListener("click",(()=>{const t=e.nextElementSibling;t.style.display="block"===t.style.display?"none":"block"}))})),t.querySelectorAll(".cmv-sel-all").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!0))}))})),t.querySelectorAll(".cmv-sel-none").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!1))}))})),t.querySelectorAll(".cmv-label, .cmv-item button").forEach((e=>{e.addEventListener("click",(()=>{const t=Number(e.dataset.idx);isNaN(t)||g(t)}))}))}function f(){const o=document.querySelector(".mobile-media-content-area");if(!o)return;if(document.getElementById(t))return;const a=document.createElement("button");a.id=t,a.textContent="Enable Custom Viewer",a.onclick=()=>{let t=document.getElementById(e);const n=t&&"none"!==t.style.display;if(n)t.style.display="none",o.style.display="",a.textContent="Enable Custom Viewer";else{t=document.createElement("div"),t.id=e,t.innerHTML='<div class="cmv-title">Media Viewer (Custom)</div><div id="cmv-body-v2">Loading…</div>',o.parentNode.insertBefore(t,o),o.style.display="none",a.textContent="Use Native Viewer",c((e=>{const{items:t,groups:n}=p(e);aItems=t,a=t,window.a=t, window.MEDIA_ITEMS=t, a=t,a,n, aItems=t,a=v(n)}))}},o.parentNode.insertBefore(a,o)}function g(e){y(),r.index=e,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0;const t=document.getElementById(n);t.style.display="flex",h()}function w(){const e=document.getElementById(n);e&&(e.style.display="none")}function b(){if(document.getElementById(n))return;const e=document.createElement("div");e.id=n,e.innerHTML=`<div id="${i}"><div class="cmv-lb-header"><span class="cmv-name"></span><div class="cmv-controls"><button data-act="prev">◀</button><button data-act="next">▶</button><button data-act="zoom-in">＋</button><button data-act="zoom-out">−</button><button data-act="zoom-reset">100%</button><button data-act="rotate-left">⟲</button><button data-act="rotate-right">⟳</button><button data-act="fit-width">Fit W</button><button data-act="fit-height">Fit H</button><button data-act="fit-original">1:1</button><button data-act="theme">☯</button><button data-act="download">⬇</button><button data-act="download-all">⇩ All</button><button data-act="download-selected">⇩ Selected</button><button data-act="close">✕</button></div></div><div class="cmv-lb-main"><div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div></div><div class="cmv-lb-thumbs"></div></div>`,document.body.appendChild(e),e.addEventListener("click",(e=>{const t=e.target.dataset.act;t&&x(t),e.target.id===n&&w()})),document.addEventListener("keydown",(e=>{const t="flex"===document.getElementById(n)?.style.display;t&&("Escape"===e.key&&w(),"ArrowRight"===e.key&&S(),"ArrowLeft"===e.key&&E())}))}function x(e){switch(e){case"close":w();break;case"prev":E();break;case"next":S();break;case"zoom-in":z();break;case"zoom-out":k();break;case"zoom-reset":H();break;case"rotate-left":C(-90);break;case"rotate-right":C(90);break;case"fit-width":r.fit="cover",T();break;case"fit-height":r.fit="contain",T();break;case"fit-original":r.fit="none",T();break;case"theme":L();break;case"download":I();break;case"download-all":A();break;case"download-selected":O()}}function E(){r.index=(r.index-1+a.length)%a.length,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0,h()}function S(){r.index=(r.index+1)%a.length,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0,h()}function z(){r.zoom*=1.2,T()}function k(){r.zoom/=1.2,T()}function H(){r.zoom=1,r.panX=0,r.panY=0,T()}function C(e){r.rotation=(r.rotation+e)%360,T()}function L(){r.theme="dark"===r.theme?"light":"dark",document.getElementById(i).classList.toggle("cmv-light","light"===r.theme)}function y(){b()}function h(){const e=function(){return a[r.index]}(),t=document.getElementById(i),n=t.querySelector(".cmv-lb-main"),o=t.querySelector(".cmv-name"),l=t.querySelector(".cmv-lb-thumbs");n.innerHTML='<div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div>',o.textContent=e.desc;let d;"image"===e.kind?(d=document.createElement("img"),d.src=e.downloadUrl):"video"===e.kind?(d=document.createElement("video"),d.src=e.downloadUrl,d.controls=!0):(d=document.createElement("iframe"),d.src=e.viewerUrl),n.appendChild(d),T(),l.innerHTML="",a.forEach(((t,n)=>{const o=document.createElement("div");if(o.className="cmv-thumb"+(n===r.index?" cmv-active":""),o.title=t.desc,"image"===t.kind){const e=document.createElement("img");e.src=t.downloadUrl,o.appendChild(e)}else o.textContent=t.ext.toUpperCase();o.onclick=()=>{r.index=n,H(),h()},l.appendChild(o)}))}function T(){const e=document.getElementById(i).querySelector("img, video, iframe"),t=function(){return a[r.index]}();e&&t&&(["image","video"].includes(t.kind)?(e.style.objectFit=r.fit,e.style.transform=`translate(${r.panX}px,${r.panY}px) scale(${r.zoom}) rotate(${r.rotation}deg)`):e.style.transform="none")}function I(){const e=function(){return a[r.index]}();let t=e.desc.replace(/[\\\/:*?"<>|]+/g,"_");t.toLowerCase().endsWith("."+e.ext)||(t+="."+e.ext);const n=document.createElement("a");n.href=e.downloadUrl,n.download=t,n.click()}function D(){const e=document.querySelector("#ID");return(e?.innerText||e?.value||"WorkOrder").trim()}function U(e){window.JSZip?e(window.JSZip):(s=document.createElement("script"),s.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",s.onload=()=>e(window.JSZip),document.head.appendChild(s))}function N(e){let t=document.getElementById("cmv-progress-v2");t||(t=document.createElement("div"),t.id="cmv-progress-v2",t.innerHTML='<div id="cmv-progress-text-v2">'+e+"</div>",document.body.appendChild(t)),t.style.display="flex",document.getElementById("cmv-progress-text-v2").innerText=e}function M(){const e=document.getElementById("cmv-progress-v2");e&&(e.style.display="none")}async function F(e,t,n){N("Preparing ZIP…");const i=new n,o=a.length;let r=0;for(const t of e){r++,N(`Downloading ${r}/${e.length}…`);const e=await fetch(t.downloadUrl),o=await e.arrayBuffer();let a=t.desc.replace(/[\\\/:*?"<>|]+/g,"_");a.toLowerCase().endsWith("."+t.ext)||(a+="."+t.ext);let l="Other";"image"===t.kind?l="Images":"video"===t.kind?l="Videos":"doc"===t.kind&&(l="Documents"),i.folder(l).file(a,o)}N("Finalizing ZIP…");const l=await i.generateAsync({type:"blob"});M();const d=document.createElement("a");d.href=URL.createObjectURL(l),d.download=t,d.click()}function A(){U((e=>F(a,D()+".zip",e)))}function O(){const e=[...document.querySelectorAll(".cmv-select:checked")].map((e=>a[e.dataset.idx]));U((t=>F(e,D()+"-selected.zip",t)))}new MutationObserver(f).observe(document.body,{childList:!0,subtree:!0}),f()})();
