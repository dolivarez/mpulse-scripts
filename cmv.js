(()=>{if(window.__CMV_V2_ACTIVE__)return;window.__CMV_V2_ACTIVE__=true;const e="cmv-panel-v2",t="cmv-toggle-v2",n="cmv-lightbox-v2",i="cmv-lightbox-main-v2";let o=null,a=[];const r={index:0,zoom:1,rotation:0,fit:"contain",theme:"dark",panX:0,panY:0};function d(){if(document.getElementById("cmv-v2-styles"))return;const e=`#${i} img,#${i} video{max-width:100%!important;max-height:100%!important;width:auto!important;height:auto!important;object-fit:contain!important;transform-origin:center center!important}#${i} iframe{width:100%!important;height:100%!important;border:none!important;object-fit:contain!important}#${e}{border:1px solid #ccc;border-radius:6px;background:#fafafa;padding:10px;margin-bottom:10px;font-size:13px}#${e} .cmv-title{font-weight:600;margin-bottom:6px}#${t}{margin-bottom:8px;padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px}.cmv-group{border:1px solid #ddd;border-radius:5px;margin-bottom:8px}.cmv-group-header{padding:6px 10px;cursor:pointer;background:#eee;font-weight:600;display:flex;justify-content:space-between;align-items:center}.cmv-group-body{display:none;padding:6px 10px;background:#fff}.cmv-item{padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:6px}.cmv-item:last-child{border-bottom:none}.cmv-label{flex:1;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cmv-select{margin-right:4px}#${n}{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);display:none;z-index:999999;align-items:center;justify-content:center}#${i}{width:80vw;height:80vh;background:#111;border-radius:8px;display:flex;flex-direction:column;overflow:hidden}.cmv-light{background:#f7f7f7!important}.cmv-lb-header{padding:6px 10px;font-size:13px;background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center}.cmv-light .cmv-lb-header{background:#ddd!important;color:#000!important}.cmv-lb-main{flex:1;background:#000;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center}.cmv-light .cmv-lb-main{background:#fafafa!important}.cmv-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);padding:10px 14px;font-size:28px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer;border-radius:20px}.cmv-nav-left{left:10px}.cmv-nav-right{right:10px}.cmv-lb-thumbs{height:80px;background:#181818;display:flex;overflow-x:auto;gap:4px;padding:4px}.cmv-thumb{width:70px;height:60px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;border:2px solid transparent;cursor:pointer;flex:0 0 auto}.cmv-thumb img{width:100%;height:100%;object-fit:contain}.cmv-thumb.cmv-active{border-color:#00aaff}#cmv-progress-v2{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;align-items:center;justify-content:center;font-size:18px;z-index:1000000}`;const t=document.createElement("style");t.id="cmv-v2-styles",t.textContent=e,document.head.appendChild(t)}function l(){if(o)return o;const e=performance.getEntries();for(const t of e){const e=t.name.match(/[?&]Token=([^&]+)/i);if(e)return o=e[1]}if(window.angular){const e=document.querySelectorAll("[ng-controller],[ng-repeat]");for(const t of e)try{const e=angular.element(t).scope();if(e?.Token)return o=e.Token;if(e?.$parent?.Token)return o=e.$parent.Token}catch(e){}}return null}function c(){try{const e=document.querySelector(".mobile-media-content-area");if(!e)return[];const t=e.querySelector("[ng-repeat='mediadetails in media']");return t?angular.element(t).scope()?.media||[]:[]}catch(e){return[]}}function s(e,t,n){const i=encodeURIComponent(e),o=encodeURIComponent(n),a=encodeURIComponent(t);return`${location.origin}/Media/DownloadMediaStream/${i}?Token=${o}&FileName=${i}&MediaKey=${a}`}function m(e,t,n){const i=`${t},${e},WorkOrderRecords`;return`${location.origin}/mediaviewer?fileName=${encodeURIComponent(i)}&Token=${encodeURIComponent(n)}`}function u(e){const t=l();if(!t)return{items:[],groups:null};const n={image:["jpg","jpeg","png","gif","bmp","tif","tiff"],video:["mp4","mov","webm","avi","wmv","mpeg","mpg"],doc:["pdf","doc","docx","xls","xlsx","csv","ppt","pptx","rtf","txt"]},i={Images:[],Videos:[],Documents:[],Other:[]},o=[];return e.forEach((e=>{const a=e.FileName,r=(a.split(".").pop()||"").toLowerCase(),d=e.Key;let l="other";n.image.includes(r)?l="image":n.video.includes(r)?l="video":n.doc.includes(r)&&(l="doc");const c={desc:e.Description||a,fileName:a,ext:r,kind:l,downloadUrl:s(a,d,t),viewerUrl:"doc"===l?m(a,d,t):s(a,d,t),flatIndex:o.length};o.push(c),"image"===l?i.Images.push(c):"video"===l?i.Videos.push(c):"doc"===l?i.Documents.push(c):i.Other.push(c)})),{items:o,groups:i}}function p(t,n){return`<div class="cmv-group"><div class="cmv-group-header">${t} (${n.length}) <span>▼</span></div><div class="cmv-group-body"><button class="cmv-sel-all">Select All</button><button class="cmv-sel-none">None</button>${n.map((e=>`<div class="cmv-item"><input type="checkbox" class="cmv-select" data-idx="${e.flatIndex}"><span class="cmv-label" data-idx="${e.flatIndex}">${e.desc}</span><button data-idx="${e.flatIndex}">Preview</button></div>`)).join("")}</div></div>`}function f(){d();const t=c(),n=document.getElementById(e)||document.createElement("div");if(n.id=e,!t.length)return n.innerHTML='<div class="cmv-title">Media Viewer (Custom)</div><i>No media found.</i>',n;const i=u(t);a=i.items,n.innerHTML=`<div class="cmv-title">Media Viewer (Custom)</div>${p("Images",i.groups.Images)}${p("Videos",i.groups.Videos)}${p("Documents",i.groups.Documents)}${p("Other",i.groups.Other)}`;const o=n.querySelectorAll(".cmv-group-header");o.forEach((e=>e.addEventListener("click",(()=>{const t=e.nextElementSibling;t.style.display="block"===t.style.display?"none":"block"}))));n.querySelectorAll(".cmv-sel-all").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!0))}))));n.querySelectorAll(".cmv-sel-none").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv-group").querySelectorAll(".cmv-select").forEach((e=>e.checked=!1))}))));return n.querySelectorAll(".cmv-label, .cmv-item button").forEach((e=>e.addEventListener("click",(t=>{const n=Number(e.dataset.idx);isNaN(n)||v(n)})))),n}function y(){const o=document.querySelector(".mobile-media-content-area");if(!o)return;let a=document.getElementById(t);a||(a=document.createElement("button"),a.id=t,a.textContent="Switch to Custom Viewer",o.parentNode.insertBefore(a,o)),a.onclick=(()=>{const t=document.getElementById(e);if(t&&"none"!==t.style.display)return t.style.display="none",o.style.display="",a.textContent="Switch to Custom Viewer",void 0;const n=f();n.style.display="",o.style.display="none",a.textContent="Switch to Native Viewer";const i=document.getElementById(e);i||o.parentNode.insertBefore(n,o)})}new MutationObserver((()=>y())).observe(document.body,{childList:!0,subtree:!0}),y();function b(){if(document.getElementById(n))return;const e=document.createElement("div");e.id=n,e.innerHTML=`<div id="${i}"><div class="cmv-lb-header"><span class="cmv-name"></span><div><button data-act="prev">◀</button><button data-act="next">▶</button><button data-act="zoom-in">+</button><button data-act="zoom-out">-</button><button data-act="zoom-reset">100%</button><button data-act="rotate-left">⟲</button><button data-act="rotate-right">⟳</button><button data-act="fit-width">Fit W</button><button data-act="fit-height">Fit H</button><button data-act="fit-original">1:1</button><button data-act="theme">☯</button><button data-act="download">⬇</button><button data-act="download-all">⇩ All</button><button data-act="download-selected">⇩ Selected</button><button data-act="close">✕</button></div></div><div class="cmv-lb-main"><div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div></div><div class="cmv-lb-thumbs"></div></div>`,document.body.appendChild(e),e.addEventListener("click",(t=>{const i=t.target.dataset.act;i&&(t.stopPropagation(),g(i)),t.target.id===n&&h()})),document.addEventListener("keydown",(e=>{const t=document.getElementById(n);if("flex"!==t.style.display)return;"Escape"===e.key&&h(),"ArrowRight"===e.key&&w(),"ArrowLeft"===e.key&&E()}));const t=e.querySelector(".cmv-lb-main");let i=!1,o=0,a=0,d=0,l=0;t.addEventListener("mousedown",(e=>{if(1!==e.button)return;const t=S();if(!["image","video"].includes(t.kind))return;e.preventDefault(),i=!0,o=e.clientX,a=e.clientY,d=r.panX,l=r.panY})),document.addEventListener("mousemove",(e=>{i&&(r.panX=d+(e.clientX-o),r.panY=l+(e.clientY-a),C())})),document.addEventListener("mouseup",(()=>i=!1))}function S(){return a[r.index]}function v(e){b(),r.index=e,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0;const t=document.getElementById(n);t.style.display="flex",x()}function h(){document.getElementById(n).style.display="none"}function g(e){switch(e){case"close":h();break;case"prev":E();break;case"next":w();break;case"zoom-in":r.zoom*=1.2,C();break;case"zoom-out":r.zoom/=1.2,C();break;case"zoom-reset":r.zoom=1,r.panX=0,r.panY=0,C();break;case"rotate-left":r.rotation=(r.rotation-90)%360,C();break;case"rotate-right":r.rotation=(r.rotation+90)%360,C();break;case"fit-width":r.fit="cover",C();break;case"fit-height":r.fit="contain",C();break;case"fit-original":r.fit="none",C();break;case"theme":r.theme="dark"===r.theme?"light":"dark";const t=document.getElementById(i);t.classList.toggle("cmv-light","light"===r.theme);break;case"download":L();break;case"download-all":P();break;case"download-selected":N()}}function w(){r.index=(r.index+1)%a.length,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0,x()}function E(){r.index=(r.index-1+a.length)%a.length,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0,x()}function x(){const e=S(),t=document.getElementById(i),n=t.querySelector(".cmv-lb-main"),o=t.querySelector(".cmv-name"),l=t.querySelector(".cmv-lb-thumbs");o.textContent=e.desc,n.innerHTML=`<div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div>`;let c;"image"===e.kind?(c=document.createElement("img"),c.src=e.downloadUrl):"video"===e.kind?(c=document.createElement("video"),c.src=e.downloadUrl,c.controls=!0):(c=document.createElement("iframe"),c.src=e.viewerUrl),n.appendChild(c),C(),l.innerHTML="",a.forEach(((e,t)=>{const n=document.createElement("div");if(n.className="cmv-thumb"+(t===r.index?" cmv-active":""),n.title=e.desc,"image"===e.kind){const t=document.createElement("img");t.src=e.downloadUrl,n.appendChild(t)}else n.textContent=e.ext.toUpperCase();n.onclick=(()=>{r.index=t,r.zoom=1,r.rotation=0,r.panX=0,r.panY=0,x()}),l.appendChild(n)}))}function C(){const e=document.getElementById(i),t=e.querySelector("img,video,iframe"),n=S();t&&(["image","video"].includes(n.kind)?(t.style.objectFit=r.fit,t.style.transform=`translate(${r.panX}px,${r.panY}px) scale(${r.zoom}) rotate(${r.rotation}deg)`):t.style.transform="none")}function L(){const e=S();let t=(e.desc||e.fileName).replace(/[\\\/:*?"<>|]/g,"_");t.toLowerCase().endsWith("."+e.ext)||(t+="."+e.ext);const n=document.createElement("a");n.href=e.downloadUrl,n.download=t,n.click()}function I(){const e=document.querySelector("#ID");return(e?.innerText||e?.value||"WorkOrder").trim()}function A(){return[...document.querySelectorAll(".cmv-select:checked")].map((e=>a[e.dataset.idx]))}function T(e){if(window.JSZip)return e(window.JSZip);const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",t.onload=(()=>e(window.JSZip)),document.head.appendChild(t)}function O(e,t,n){M("Preparing ZIP…");const i=new n;let o=0;return async function(){for(const n of e){o++,M(`Downloading ${o}/${e.length}…`);try{const e=await fetch(n.downloadUrl),o=await e.arrayBuffer();let a=n.desc.replace(/[\\\/:*?"<>|]/g,"_");a.toLowerCase().endsWith("."+n.ext)||(a+="."+n.ext);let r="Other";"image"===n.kind?r="Images":"video"===n.kind?r="Videos":"doc"===n.kind&&(r="Documents"),i.folder(r).file(a,o)}catch(e){console.error("Download failed:",n,e)}}M("Finalizing ZIP…");const a=await i.generateAsync({type:"blob"});k();const r=document.createElement("a");r.href=URL.createObjectURL(a),r.download=t,r.click()}()}function M(e){let t=document.getElementById("cmv-progress-v2");t||(t=document.createElement("div"),t.id="cmv-progress-v2",t.innerHTML=`<div id="cmv-progress-text-v2">${e}</div>`,document.body.appendChild(t)),t.style.display="flex",document.getElementById("cmv-progress-text-v2").innerText=e}function k(){const e=document.getElementById("cmv-progress-v2");e&&(e.style.display="none")}function P(){T((e=>O(a,I()+".zip",e)()))}function N(){const e=A();T((t=>O(e,I()+"-selected.zip",t)()))}})();
