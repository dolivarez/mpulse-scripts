(()=>{if(window.__CMV_V2_ACTIVE__)return;window.__CMV_V2_ACTIVE__=true;const O="cmv-panel-v2",b="cmv-toggle-v2",L="cmv-lightbox-v2",C="cmv-lightbox-main-v2";let u=null,g=[];const p={index:0,zoom:1,rotation:0,fit:"contain",theme:"dark",panX:0,panY:0,thumbsOpen:!1};function d(){if(document.getElementById("cmv-v2-styles"))return;let e=`#${O}{border:1px solid #ccc;border-radius:6px;background:#fafafa;padding:10px;margin-bottom:10px;font-size:13px}#${b}{margin-bottom:8px;padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px}.cmv-group{border:1px solid #ddd;border-radius:5px;margin-bottom:8px}.cmv-group-header{padding:6px 10px;background:#eee;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center}.cmv-group-body{display:none;padding:6px 10px;background:#fff}.cmv-item{padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:6px}.cmv-item:last-child{border-bottom:none}.cmv-label{flex:1;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cmv-select{margin-right:4px}#${L}{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);display:none;z-index:999999;align-items:center;justify-content:center}#${C}{width:80vw;height:80vh;background:#111;border-radius:8px;display:flex;flex-direction:column;overflow:hidden}.cmv-light{background:#f7f7f7!important}.cmv-lb-header{padding:6px 10px;background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center}.cmv-light .cmv-lb-header{background:#ddd!important;color:#000!important}.cmv-lb-main{flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}.cmv-light .cmv-lb-main{background:#fafafa!important}.cmv-lb-main img,.cmv-lb-main video{max-width:100%!important;max-height:100%!important;width:auto!important;height:auto!important;object-fit:contain!important;transform-origin:center center!important}.cmv-lb-main iframe{width:100%!important;height:100%!important;border:none!important;object-fit:contain!important}.cmv-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);padding:10px 14px;font-size:28px;border-radius:20px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer}.cmv-nav-left{left:10px}.cmv-nav-right{right:10px}.cmv-lb-thumbs{height:80px;background:#181818;display:none;overflow-x:auto;gap:4px;padding:4px;align-items:center}.cmv-thumb{width:70px;height:60px;background:#333;display:flex;align-items:center;justify-content:center;border-radius:4px;border:2px solid transparent;cursor:pointer;flex:0 0 auto}.cmv-thumb img{width:100%;height:100%;object-fit:contain}.cmv-thumb.cmv-active{border-color:#00aaff}#cmv-progress-v2{position:fixed;top:0;left:0;width:100%;height:100%;display:none;color:#fff;align-items:center;justify-content:center;background:rgba(0,0,0,.5);font-size:18px;z-index:1000000}`;let t=document.createElement("style");t.id="cmv-v2-styles",t.textContent=e,document.head.appendChild(t)}function h(){if(u)return u;let e=performance.getEntries();for(let t of e){let n=t.name.match(/[?&]Token=([^&]+)/i);if(n)return u=n[1]}if(window.angular){let t=document.querySelectorAll("[ng-controller],[ng-repeat]");for(let n of t)try{let r=angular.element(n).scope();if(r?.Token)return u=r.Token;if(r?.$parent?.Token)return u=r.$parent.Token}catch{}}return null}function f(){try{let e=document.querySelector(".mobile-media-content-area");if(!e)return[];let t=e.querySelector("[ng-repeat='mediadetails in media']");return t?angular.element(t).scope()?.media||[]:[]}catch{return[]}}function w(e,t,n){let r=encodeURIComponent(e),a=encodeURIComponent(n),s=encodeURIComponent(t);return`${location.origin}/Media/DownloadMediaStream/${r}?Token=${a}&FileName=${r}&MediaKey=${s}`}function y(e,t,n){let r=`${t},${e},WorkOrderRecords`;return`${location.origin}/mediaviewer?fileName=${encodeURIComponent(r)}&Token=${encodeURIComponent(n)}`}function E(e){let t=h();if(!t)return{items:[],groups:null};let n={image:["jpg","jpeg","png","gif","bmp","tif","tiff"],video:["mp4","mov","webm","avi","wmv","mpeg","mpg"],doc:["pdf","doc","docx","xls","xlsx","csv","ppt","pptx","rtf","txt"]},r={Images:[],Videos:[],Documents:[],Other:[]},a=[];return e.forEach(s=>{let l=s.FileName,i=(l.split(".").pop()||"").toLowerCase(),o="other";n.image.includes(i)?o="image":n.video.includes(i)?o="video":n.doc.includes(i)&&(o="doc");let m={desc:s.Description||l,fileName:l,ext:i,kind:o,downloadUrl:w(l,s.Key,t),viewerUrl:o==="doc"?y(l,s.Key,t):w(l,s.Key,t),flatIndex:a.length};a.push(m),o==="image"?r.Images.push(m):o==="video"?r.Videos.push(m):o==="doc"?r.Documents.push(m):r.Other.push(m)}),{items:a,groups:r}}function I(e,t){return`<div class="cmv-group"><div class="cmv-group-header">${e} (${t.length})<span>▼</span></div><div class="cmv-group-body"><button class="cmv-sel-all">Select All</button><button class="cmv-sel-none">None</button>${t.map(o=>`<div class="cmv-item"><input type="checkbox" class="cmv-select" data-idx="${o.flatIndex}"><span class="cmv-label" data-idx="${o.flatIndex}">${o.desc}</span><button data-idx="${o.flatIndex}">Preview</button></div>`).join("")}</div></div>`}function x(){d();let e=f(),t=document.getElementById(O)||document.createElement("div");if(t.id=O,!e.length)return t.innerHTML=`<div class="cmv-title">Media Viewer (Custom)</div><i>No media found.</i>`,t;let{items:n,groups:r}=E(e);return g=n,t.innerHTML=`<div class="cmv-title">Media Viewer (Custom)</div>${I("Images",r.Images)}${I("Videos",r.Videos)}${I("Documents",r.Documents)}${I("Other",r.Other)}`,t.querySelectorAll(".cmv-group-header").forEach(a=>a.onclick=()=>{let s=a.nextElementSibling;s.style.display=s.style.display==="block"?"none":"block"}),t.querySelectorAll(".cmv-sel-all").forEach(a=>a.onclick=e=>{e.stopPropagation(),a.closest(".cmv-group").querySelectorAll(".cmv-select").forEach(s=>s.checked=!0)}),t.querySelectorAll(".cmv-sel-none").forEach(a=>a.onclick=e=>{e.stopPropagation(),a.closest(".cmv-group").querySelectorAll(".cmv-select").forEach(s=>s.checked=!1)}),t.querySelectorAll(".cmv-label, .cmv-item button").forEach(a=>a.onclick=e=>{let s=Number(a.dataset.idx);!isNaN(s)&&A(s)}),t}function v(){let e=document.querySelector(".mobile-media-content-area");if(!e)return;let t=document.getElementById(b);t||(t=document.createElement("button"),t.id=b,t.textContent="Switch to Custom Viewer",e.parentNode.insertBefore(t,e)),t.onclick=()=>{let n=document.getElementById(O);if(n&&n.style.display!=="none")n.style.display="none",e.style.display="",t.textContent="Switch to Custom Viewer";else{let r=x();r.style.display="",e.style.display="none",t.textContent="Switch to Native Viewer";let a=document.getElementById(O);a||e.parentNode.insertBefore(r,e)}}}function M(){if(document.getElementById(L))return;let e=document.createElement("div");e.id=L,e.innerHTML=`<div id="${C}"><div class="cmv-lb-header"><span class="cmv-name"></span><div><button data-act="thumbs">TH</button><button data-act="prev">◀</button><button data-act="next">▶</button><button data-act="zoom-in">+</button><button data-act="zoom-out">-</button><button data-act="zoom-reset">100%</button><button data-act="rotate-left">⟲</button><button data-act="rotate-right">⟳</button><button data-act="fit-width">FitW</button><button data-act="fit-height">FitH</button><button data-act="fit-original">1:1</button><button data-act="theme">☯</button><button data-act="download">⬇</button><button data-act="close">✕</button></div></div><div class="cmv-lb-main"><div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div></div><div class="cmv-lb-thumbs"></div></div>`,document.body.appendChild(e),e.addEventListener("click",t=>{let n=t.target.dataset.act;if(n)switch(n){case"close":T();break;case"prev":S();break;case"next":k();break;case"zoom-in":p.zoom*=1.2,j();break;case"zoom-out":p.zoom/=1.2,j();break;case"zoom-reset":p.zoom=1,p.panX=0,p.panY=0,j();break;case"rotate-left":p.rotation=(p.rotation-90)%360,j();break;case"rotate-right":p.rotation=(p.rotation+90)%360,j();break;case"fit-width":p.fit="cover",j();break;case"fit-height":p.fit="contain",j();break;case"fit-original":p.fit="none",j();break;case"theme":p.theme=p.theme==="dark"?"light":"dark";let r=document.getElementById(C);r.classList.toggle("cmv-light",p.theme==="light");break;case"download":P();break;case"thumbs":p.thumbsOpen=!p.thumbsOpen,q();break}}),e.addEventListener("click",t=>{t.target.id===L&&T()});let t=e.querySelector(".cmv-lb-main"),n=!1,r=0,a=0,s=0,l=0;t.addEventListener("mousedown",i=>{if(i.button!==1)return;let o=g[p.index];if(!["image","video"].includes(o.kind))return;i.preventDefault(),n=!0,r=i.clientX,a=i.clientY,s=p.panX,l=p.panY});document.addEventListener("mousemove",i=>{n&&(p.panX=s+(i.clientX-r),p.panY=l+(i.clientY-a),j())}),document.addEventListener("mouseup",()=>n=!1)}function A(e){M(),p.index=e,p.zoom=1,p.rotation=0,p.panX=0,p.panY=0;let t=document.getElementById(L);t.style.display="flex",N()}function T(){document.getElementById(L).style.display="none"}function S(){p.index=(p.index-1+g.length)%g.length,p.zoom=1,p.rotation=0,p.panX=0,p.panY=0,N(!0)}function k(){p.index=(p.index+1)%g.length,p.zoom=1,p.rotation=0,p.panX=0,p.panY=0,N(!0)}function N(e=!1){let t=g[p.index],n=document.getElementById(C),r=n.querySelector(".cmv-lb-main"),a=n.querySelector(".cmv-name"),s=n.querySelector(".cmv-lb-thumbs");a.textContent=t.desc,r.innerHTML=`<div class="cmv-nav-arrow cmv-nav-left" data-act="prev">❮</div><div class="cmv-nav-arrow cmv-nav-right" data-act="next">❯</div>`;let l;t.kind==="image"?(l=document.createElement("img"),l.src=t.downloadUrl):t.kind==="video"?(l=document.createElement("video"),l.src=t.downloadUrl,l.controls=!0):(l=document.createElement("iframe"),l.src=t.viewerUrl),l.style.opacity=e?"1":"0",r.appendChild(l),requestAnimationFrame(()=>l.style.opacity="1"),j(),s.innerHTML="",g.forEach((i,o)=>{let m=document.createElement("div");m.className="cmv-thumb"+(o===p.index?" cmv-active":""),m.title=i.desc,i.kind==="image"?(()=>{let v=document.createElement("img");v.src=i.downloadUrl,m.appendChild(v)})():m.textContent=i.ext.toUpperCase(),m.onclick=()=>{p.index=o,p.zoom=1,p.rotation=0,p.panX=0,p.panY=0,N(!0)},s.appendChild(m)}),q()}function q(){let e=document.querySelector(".cmv-lb-thumbs");e.style.display=p.thumbsOpen?"flex":"none"}function j(){let e=document.getElementById(C),t=e.querySelector("img,video,iframe");if(!t)return;let n=g[p.index];["image","video"].includes(n.kind)?(t.style.objectFit=p.fit,t.style.transform=`translate(${p.panX}px,${p.panY}px) scale(${p.zoom}) rotate(${p.rotation}deg)`):t.style.transform="none"}function P(){let e=g[p.index],t=(e.desc||e.fileName).replace(/[\\\/:*?"<>|]/g,"_");t.toLowerCase().endsWith("."+e.ext)||(t+="."+e.ext);let n=document.createElement("a");n.href=e.downloadUrl,n.download=t,n.click()}function _(e){let t=document.getElementById("ID");return(t?.innerText||t?.value||"WorkOrder").trim()}function R(){return[...document.querySelectorAll(".cmv-select:checked")].map(e=>g[e.dataset.idx])}function F(e){return window.JSZip?e(window.JSZip):(s=document.createElement("script"),s.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",s.onload=()=>e(window.JSZip),void document.head.appendChild(s));var s}async function H(e,t,n){let r=document.getElementById("cmv-progress-v2");r||(r=document.createElement("div"),r.id="cmv-progress-v2",r.innerHTML=`<div id="cmv-progress-text-v2">${t}</div>`,document.body.appendChild(r)),r.style.display="flex";let a=document.getElementById("cmv-progress-text-v2"),s=new n,l=0;for(let o of e){l++,a.innerText=`Downloading ${l}/${e.length}…`;try{let m=await(await fetch(o.downloadUrl)).arrayBuffer(),v=o.desc.replace(/[\\\/:*?"<>|]/g,"_");v.toLowerCase().endsWith("."+o.ext)||(v+="."+o.ext);let D="Other";o.kind==="image"?D="Images":o.kind==="video"?D="Videos":o.kind==="doc"&&(D="Documents"),s.folder(D).file(v,m)}catch{}}a.innerText="Finalizing ZIP…";let i=await s.generateAsync({type:"blob"});r.style.display="none";let o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=t,o.click()}function B(){let e=g;F(t=>H(e,_()+".zip",t))}function J(){let e=R();F(t=>H(e,_()+"-selected.zip",t))}new MutationObserver(()=>v()).observe(document.body,{childList:!0,subtree:!0}),v();})();
