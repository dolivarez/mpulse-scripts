(()=>{if(window.__CMV_V3_ACTIVE__)return;window.__CMV_V3_ACTIVE__=!0;const e="cmv3-panel",t="cmv3-toggle",n="cmv3-lightbox",o="cmv3-lightbox-main";let i=null,r=[];const a={index:0,zoom:1,rotate:0,fit:"contain",theme:"dark",panX:0,panY:0};function c(){if(document.getElementById("cmv3-style"))return;const e=`#${t}{background:#0078d4;color:#fff;border:none;padding:6px 12px;border-radius:4px;margin-bottom:8px;font-size:13px;cursor:pointer}#${e}{border:1px solid #ccc;border-radius:6px;background:#fafafa;padding:10px;margin-bottom:10px;font-size:13px}#${e} .cmv3-title{font-weight:600;margin-bottom:6px}.cmv3-group{border:1px solid #ddd;margin-bottom:6px;border-radius:5px}.cmv3-group-header{background:#eee;padding:6px 10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600}.cmv3-group-body{padding:6px 10px;display:none;background:#fff}.cmv3-item{padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:6px}.cmv3-item:last-child{border-bottom:none}.cmv3-label{flex:1;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#${n}{position:fixed;top:0;left:0;width:100vw;height:100vh;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.85);z-index:999999}#${o}{width:80vw;height:80vh;background:#111;border-radius:8px;display:flex;flex-direction:column;overflow:hidden}.cmv3-light{background:#f8f8f8!important}.cmv3-lb-header{background:#222;color:#fff;padding:6px 10px;display:flex;flex-direction:column;gap:4px}.cmv3-light .cmv3-lb-header{background:#ddd;color:#000}.cmv3-top-row{display:flex;justify-content:center;font-weight:600;font-size:13px;margin-bottom:2px}.cmv3-bottom-row{display:flex;justify-content:center;gap:6px;flex-wrap:wrap}.cmv3-lb-main{flex:1;display:flex;justify-content:center;align-items:center;background:#000;position:relative;overflow:hidden}.cmv3-light .cmv3-lb-main{background:#fafafa}.cmv3-lb-main img,.cmv3-lb-main video{max-width:100%;max-height:100%;object-fit:contain!important;transform-origin:center center!important}.cmv3-lb-main iframe{width:100%!important;height:100%!important;border:none!important;object-fit:contain!important}.cmv3-nav{position:absolute;top:50%;transform:translateY(-50%);padding:10px;font-size:28px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer;border-radius:20px}.cmv3-left{left:10px}.cmv3-right{right:10px}.cmv3-thumbs{background:#181818;display:flex;gap:4px;padding:4px;height:80px;overflow-x:auto}.cmv3-thumb{width:70px;height:60px;background:#333;border-radius:4px;display:flex;justify-content:center;align-items:center;border:2px solid transparent;flex:0 0 auto;cursor:pointer}.cmv3-thumb.cmv3-active{border-color:#00aaff}#cmv3-progress{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);display:none;justify-content:center;align-items:center;color:#fff;font-size:18px;z-index:1000000}`;const t=document.createElement("style");t.id="cmv3-style",t.textContent=e,document.head.appendChild(t)}function d(){if(i)return i;const e=performance.getEntries();for(const t of e){const e=t.name.match(/[?&]Token=([^&]+)/i);if(e)return i=e[1]}if(window.angular){const e=document.querySelectorAll("[ng-controller],[ng-repeat]");for(const t of e)try{const e=angular.element(t).scope();if(e?.Token)return i=e.Token;if(e?.$parent?.Token)return i=e.$parent.Token}catch{}}return null}function l(){try{const e=document.querySelector(".mobile-media-content-area");if(!e)return[];const t=e.querySelector("[ng-repeat='mediadetails in media']");return t?angular.element(t).scope()?.media||[]:[]}catch{return[]}}function s(e){return e.replace(/[\\\/:*?"<>|]/g,"_")}function u(e,t,n){return`${location.origin}/Media/DownloadMediaStream/${encodeURIComponent(e)}?Token=${encodeURIComponent(n)}&FileName=${encodeURIComponent(e)}&MediaKey=${encodeURIComponent(t)}`}function m(e,t,n){const o=`${t},${e},WorkOrderRecords`;return`${location.origin}/mediaviewer?fileName=${encodeURIComponent(o)}&Token=${encodeURIComponent(n)}`}function f(e){const t=d();if(!t)return{items:[],groups:null};const n={image:["jpg","jpeg","png","gif","bmp","tif","tiff"],video:["mp4","mov","webm","avi","wmv","mpeg","mpg"],doc:["pdf","doc","docx","xls","xlsx","csv","ppt","pptx","rtf","txt"]},o={Images:[],Videos:[],Documents:[],Other:[]},i=[];return e.forEach((e=>{const r=e.FileName,a=(r.split(".").pop()||"").toLowerCase(),c=e.Key;let d="other";n.image.includes(a)?d="image":n.video.includes(a)?d="video":n.doc.includes(a)&&(d="doc");const l={desc:e.Description||r,file:r,ext:a,kind:d,download:u(r,c,t),view:"doc"===d?m(r,c,t):u(r,c,t),idx:i.length};i.push(l),"image"===d?o.Images.push(l):"video"===d?o.Videos.push(l):"doc"===d?o.Documents.push(l):o.Other.push(l)})),{items:i,groups:o}}function p(t){return`
      <div class="cmv3-group">
        <div class="cmv3-group-header">${t} (${this.length}) <span>▼</span></div>
        <div class="cmv3-group-body">
          <button class="cmv3-sel-all">Select All</button>
          <button class="cmv3-sel-none">None</button>
          ${this.map((e=>`
            <div class="cmv3-item">
              <input type="checkbox" class="cmv3-select" data-idx="${e.idx}">
              <span class="cmv3-label" data-idx="${e.idx}">${e.desc}</span>
              <button class="cmv3-preview" data-idx="${e.idx}">Preview</button>
            </div>
          `)).join("")}
        </div>
      </div>`}function g(){c();const t=l();let n=document.getElementById(e);if(!t.length)return n?(n.innerHTML=`<div class="cmv3-title">Custom Media Viewer</div><i>No media found.</i>`,n):(n=document.createElement("div"),n.id=e,n.innerHTML=`<div class="cmv3-title">Custom Media Viewer</div><i>No media found.</i>`,n);const{items:o,groups:i}=f(t);return r=o,n|| (n=document.createElement("div"),n.id=e),n.innerHTML=`
      <div class="cmv3-title">Custom Media Viewer</div>
      ${p.call(i.Images,"Images")}
      ${p.call(i.Videos,"Videos")}
      ${p.call(i.Documents,"Documents")}
      ${p.call(i.Other,"Other")}
    `,n.querySelectorAll(".cmv3-group-header").forEach((e=>e.addEventListener("click",(()=>{const t=e.nextElementSibling;t.style.display="block"===t.style.display?"none":"block"})))),n.querySelectorAll(".cmv3-sel-all").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv3-group").querySelectorAll(".cmv3-select").forEach((e=>e.checked=!0))})))),n.querySelectorAll(".cmv3-sel-none").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),e.closest(".cmv3-group").querySelectorAll(".cmv3-select").forEach((e=>e.checked=!1))})))),n.querySelectorAll(".cmv3-label,.cmv3-preview").forEach((e=>e.addEventListener("click",(e=>{v(Number(e.target.dataset.idx))})))),n}function y(){const o=document.querySelector(".mobile-media-content-area");if(!o)return;let i=document.getElementById(t);i||(i=document.createElement("button"),i.id=t,i.textContent="Switch to Custom Viewer",o.parentNode.insertBefore(i,o)),i.onclick=()=>{const t=document.getElementById(e);if(t&&"none"!==t.style.display)return t.style.display="none",o.style.display="",i.textContent="Switch to Custom Viewer",void 0;const n=g();n.style.display="",o.style.display="none",i.textContent="Switch to Native Viewer",t||o.parentNode.insertBefore(n,o)}}new MutationObserver((()=>y())).observe(document.body,{childList:!0,subtree:!0}),y();function h(){if(document.getElementById(n))return;const e=document.createElement("div");e.id=n,e.innerHTML=`
      <div id="${o}">
        <div class="cmv3-lb-header">
          <div class="cmv3-top-row"><span class="cmv3-name"></span></div>
          <div class="cmv3-bottom-row">
            <button data-act="prev">◀</button>
            <button data-act="next">▶</button>
            <button data-act="zoom-in">+</button>
            <button data-act="zoom-out">-</button>
            <button data-act="zoom-reset">100%</button>
            <button data-act="rotate-left">⟲</button>
            <button data-act="rotate-right">⟳</button>
            <button data-act="fit-width">Fit W</button>
            <button data-act="fit-height">Fit H</button>
            <button data-act="fit-original">1:1</button>
            <button data-act="theme">☯</button>
            <button data-act="download">⬇</button>
            <button data-act="download-all">⇩ All</button>
            <button data-act="download-selected">⇩ Selected</button>
            <button data-act="close">✕</button>
          </div>
        </div>
        <div class="cmv3-lb-main">
          <div class="cmv3-nav cmv3-left" data-act="prev">❮</div>
          <div class="cmv3-nav cmv3-right" data-act="next">❯</div>
        </div>
        <div class="cmv3-thumbs"></div>
      </div>
    `,document.body.appendChild(e),e.addEventListener("click",(e=>{const t=e.target.dataset.act;t&&(e.stopPropagation(),x(t))})),e.addEventListener("click",(t=>{t.target.id===n&&b()})),document.addEventListener("keydown",(e=>{if("flex"===document.getElementById(n).style.display)switch(e.key){case"Escape":b();break;case"ArrowLeft":S();break;case"ArrowRight":T()}}));const t=e.querySelector(".cmv3-lb-main");let o,i,r,c;document.addEventListener("mouseup",(()=>o=!1)),t.addEventListener("mousedown",(t=>{1===t.button&&"image"===w().kind&&(t.preventDefault(),o=!0,i=t.clientX,r=t.clientY,c={x:a.panX,y:a.panY})})),document.addEventListener("mousemove",(e=>{o&&(a.panX=c.x+(e.clientX-i),a.panY=c.y+(e.clientY-r),L())}))}function v(e){h(),a.index=e,a.zoom=1,a.rotate=0,a.panX=0,a.panY=0;const t=document.getElementById(n);t.style.display="flex",E()}function b(){document.getElementById(n).style.display="none"}function w(){return r[a.index]}function T(){a.index=(a.index+1)%r.length,_( ),E(!0)}function S(){a.index=(a.index-1+r.length)%r.length,_( ),E(!0)}function x(e){switch(e){case"prev":S();break;case"next":T();break;case"zoom-in":a.zoom*=1.2,L();break;case"zoom-out":a.zoom/=1.2,L();break;case"zoom-reset":a.zoom=1,a.panX=0,a.panY=0,L();break;case"rotate-left":a.rotate-=90,L();break;case"rotate-right":a.rotate+=90,L();break;case"fit-width":a.fit="cover",L();break;case"fit-height":a.fit="contain",L();break;case"fit-original":a.fit="none",L();break;case"theme":!function(){a.theme="dark"===a.theme?"light":"dark",document.getElementById(o).classList.toggle("cmv3-light","light"===a.theme)}();break;case"download":C();break;case"download-all":A();break;case"download-selected":k();break;case"close":b()}}function _(){a.zoom=1,a.rotate=0,a.panX=0,a.panY=0}function E(e){const t=w(),i=document.getElementById(o),n=i.querySelector(".cmv3-lb-main"),s=i.querySelector(".cmv3-name"),u=i.querySelector(".cmv3-thumbs");s.textContent=t.desc,n.innerHTML=`
      <div class="cmv3-nav cmv3-left" data-act="prev">❮</div>
      <div class="cmv3-nav cmv3-right" data-act="next">❯</div>
    `;let m;"image"===t.kind?(m=document.createElement("img"),m.src=t.download):"video"===t.kind?(m=document.createElement("video"),m.src=t.download,m.controls=!0):(m=document.createElement("iframe"),m.src=t.view),m.style.opacity=e?"1":"0",n.appendChild(m),requestAnimationFrame((()=>m.style.opacity="1")),L(),u.innerHTML="",r.forEach(((e,t)=>{const o=document.createElement("div");o.className="cmv3-thumb"+(t===a.index?" cmv3-active":""),o.title=e.desc,"image"===e.kind?(()=>{const t=document.createElement("img");t.src=e.download,o.appendChild(t)})():o.textContent=e.ext.toUpperCase(),o.onclick=()=>{a.index=t,_(),E(!0)},u.appendChild(o)}))}function L(){const e=document.querySelector(`#${o} img, #${o} video`),t=w();e&&"doc"!==t.kind&&(e.style.objectFit=a.fit,e.style.transform=`translate(${a.panX}px,${a.panY}px) scale(${a.zoom}) rotate(${a.rotate}deg)`)}function C(){const e=w();let t=s(e.desc);t.endsWith("."+e.ext)||(t+="."+e.ext);const n=document.createElement("a");n.href=e.download,n.download=t,n.click()}function O(){const e=document.querySelector("#ID");return(e?.innerText||e?.value||"WorkOrder").trim()}function k(){const e=[...document.querySelectorAll(".cmv3-select:checked")].map((e=>r[Number(e.dataset.idx)]));j(e,O()+"-selected.zip")}function A(){j(r,O()+".zip")}function j(e,t){(function(e){if(window.JSZip)return e(window.JSZip);const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",t.onload=()=>e(window.JSZip),document.head.appendChild(t)})((n=>async function(e,t,n){!function(e){let t=document.getElementById("cmv3-progress");t||(t=document.createElement("div"),t.id="cmv3-progress",t.innerHTML=`<div>${e}</div>`,document.body.appendChild(t)),t.style.display="flex",t.firstChild.textContent=e}("Preparing ZIP...");const o=new n;let i=0;for(const n of e){i++,function(e){let t=document.getElementById("cmv3-progress");t.style.display="flex",t.firstChild.textContent=e}(`Downloading ${i}/${e.length}…`);try{const t=await(await fetch(n.download)).arrayBuffer();let i=s(n.desc);i.endsWith("."+n.ext)||(i+="."+n.ext);let r="Other";"image"===n.kind?r="Images":"video"===n.kind?r="Videos":"doc"===n.kind&&(r="Documents"),o.folder(r).file(i,t)}catch(e){console.error("Fail:",n,e)}}!function(){const e=document.getElementById("cmv3-progress");e&&(e.style.display="none")}();const i=await o.generateAsync({type:"blob"}),r=document.createElement("a");r.href=URL.createObjectURL(i),r.download=t,r.click()}(e,t,n)))}})();
